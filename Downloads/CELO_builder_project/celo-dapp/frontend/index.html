<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Celo SimplePayments</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #FCFF52 0%, #35CD8C 50%, #000000 100%);
        min-height: 100vh;
        color: #333;
      }
      body.dark-theme {
        background: linear-gradient(135deg, #222 0%, #222 100%);
        color: #eee;
      }
      body.dark-theme .container {
        background: #222;
        color: #eee;
        box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      }
      body.dark-theme .section {
        background: #333;
        color: #eee;
        border-left: 5px solid #FCFF52;
      }
      body.dark-theme h1, body.dark-theme h3, body.dark-theme .badge {
        color: #FCFF52;
      }
      body.dark-theme input, body.dark-theme textarea {
        background: #222;
        color: #FCFF52;
        border-color: #444;
      }
      body.dark-theme button {
        background: linear-gradient(135deg, #FCFF52 0%, #35CD8C 100%);
        color: #222;
      }
      body.dark-theme .info, body.dark-theme .success, body.dark-theme .error {
        background: #222;
        color: #FCFF52;
        border-left: 4px solid #35CD8C;
      }
      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        margin: 20px 0;
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
        border-bottom: 3px solid #35CD8C;
        padding-bottom: 20px;
      }
      h1 {
        color: #000000;
        margin-bottom: 5px;
        font-size: 2.5em;
        font-weight: 700;
      }
      .subtitle {
        color: #35CD8C;
        font-size: 1.1em;
        font-weight: 500;
      }
      .badge {
        display: inline-block;
        background: #FCFF52;
        color: #000;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 10px;
      }
      .section {
        margin: 25px 0;
        padding: 25px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border-left: 5px solid #35CD8C;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }
      .section h3 {
        margin-top: 0;
        color: #000000;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .section h3::before {
        content: '';
        width: 8px;
        height: 8px;
        background: #35CD8C;
        border-radius: 50%;
      }
      input, textarea {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
        transition: border-color 0.3s;
      }
      input:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      button {
        background: linear-gradient(135deg, #35CD8C 0%, #FCFF52 100%);
        color: #000000;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 700;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 10px;
        box-shadow: 0 4px 15px rgba(53, 205, 140, 0.3);
      }
      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(53, 205, 140, 0.5);
        background: linear-gradient(135deg, #FCFF52 0%, #35CD8C 100%);
      }
      button:active {
        transform: translateY(-1px);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .info {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
      }
      .success {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #4caf50;
      }
      .error {
        background: #ffebee;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #f44336;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 2px solid #35CD8C;
        transition: transform 0.3s ease;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(53, 205, 140, 0.2);
      }
      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #35CD8C;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      }
      .stat-label {
        font-size: 13px;
        color: #666;
        margin-top: 8px;
        font-weight: 500;
      }
      #status {
        min-height: 20px;
        margin: 15px 0;
      }
      .payment-history {
        max-height: 300px;
        overflow-y: auto;
      }
      .payment-item {
        background: white;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }
      .payment-item .address {
        font-family: monospace;
        font-size: 12px;
        color: #666;
      }
      .payment-item .amount {
        font-weight: bold;
        color: #4caf50;
      }
    </style>
  </head>
  <body>
    <div style="position:fixed;top:18px;left:18px;z-index:1001;">
      <button id="themeToggleBtn" style="padding:8px 18px;border-radius:20px;font-weight:600;background:#eee;color:#333;box-shadow:0 2px 8px rgba(0,0,0,0.08);" onclick="toggleTheme()">ðŸŒ— Toggle Theme</button>
    </div>
    <div class="container">
      <div class="header">
        <h1>ï¿½ Celo Payments</h1>
        <p class="subtitle">Decentralized Payment DApp</p>
        <span class="badge">Celo Mainnet â€¢ Chain ID: 42220</span>
      </div>

      <div class="section">
        <h3>ðŸ”— Connect Wallet</h3>
        <button id="connectBtn" onclick="connectWallet()">Connect MetaMask</button>
        <div id="walletInfo" style="display:none;" class="info">
          <strong>Connected:</strong> <span id="walletAddress"></span><br>
          <strong>Balance:</strong> <span id="walletBalance"></span> CELO
        </div>
      </div>

      <div class="section">
        <h3>ðŸ“Š Contract Info</h3>
        <div class="info">
          <strong>Select Contract:</strong>
          <select id="contractSelect" onchange="switchContract()" style="width: 100%; padding: 8px; margin: 8px 0; border-radius: 6px; border: 2px solid #667eea;">
            <option value="primary">CA 1: 0x0B33...1402</option>
            <option value="secondary">CA 2: 0xb690...FB65</option>
            <option value="tertiary">CA 3: 0x5d0F...c75D</option>
          </select>
          <strong>Full Address:</strong><br>
          <span id="contractAddr" style="font-family: monospace; word-break: break-all;">Loading...</span>
        </div>
        <button onclick="loadStats()">Refresh Stats</button>
        <div class="stats" id="statsContainer" style="display:none;">
          <div class="stat-card">
            <div class="stat-value" id="statBalance">0</div>
            <div class="stat-label">Contract Balance (CELO)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statReceived">0</div>
            <div class="stat-label">Total Received</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statWithdrawn">0</div>
            <div class="stat-label">Total Withdrawn</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPayments">0</div>
            <div class="stat-label">Payment Count</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>ðŸ’° Send Payment</h3>
          <div id="addressBookPanel" class="info" style="margin-bottom:10px;">
            <b>Address Book</b>
            <div id="addressBookList" style="margin:8px 0;"></div>
            <input type="text" id="addressBookAddress" placeholder="0x..." style="width:60%;" />
            <input type="text" id="addressBookLabel" placeholder="Label (e.g. Alice)" style="width:30%;" />
            <button type="button" style="width:auto;" onclick="addAddressBookEntry()">Add</button>
            <span id="addressBookStatus" style="font-size:12px; color:#666;"></span>
          </div>
              function renderAddressBook() {
                const list = addressBook.getAll();
                const container = document.getElementById('addressBookList');
                if (!container) return;
                if (list.length === 0) { container.innerHTML = '<em>No saved addresses.</em>'; return; }
                container.innerHTML = list.map(e => `
                  <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                    <span style="font-family:monospace;">${e.address}</span>
                    <span style="background:#eee;padding:2px 8px;border-radius:12px;font-size:12px;">${e.label}</span>
                    <button onclick="selectAddressBookEntry('${e.address}')" style="padding:2px 8px;">Use</button>
                    <button onclick="removeAddressBookEntry('${e.address}')" style="padding:2px 8px;color:#F44336;">âœ•</button>
                  </div>
                `).join('');
              }

              function addAddressBookEntry() {
                const addr = document.getElementById('addressBookAddress').value;
                const label = document.getElementById('addressBookLabel').value;
                const status = document.getElementById('addressBookStatus');
                if (!addr) { status.textContent = 'Address required.'; status.style.color='#F44336'; return; }
                if (addressBook.add(addr, label)) {
                  status.textContent = 'Added.'; status.style.color='#35CD8C';
                  document.getElementById('addressBookAddress').value = '';
                  document.getElementById('addressBookLabel').value = '';
                  renderAddressBook();
                } else {
                  status.textContent = 'Address already exists or invalid.'; status.style.color='#F44336';
                }
              }

              function removeAddressBookEntry(addr) {
                addressBook.remove(addr);
                renderAddressBook();
              }

              function selectAddressBookEntry(addr) {
                document.getElementById('paymentMemo').value = addressBook.getLabel(addr);
                document.getElementById('paymentAmount').focus();
                document.getElementById('addressBookAddress').value = addr;
                toast.info('Selected', 'Address pasted to form', { duration: 1500 });
              }

              window.addEventListener('DOMContentLoaded', renderAddressBook);
        <label>
          Amount (CELO):
          <input type="number" id="paymentAmount" placeholder="0.001" step="0.001" value="0.001">
        </label>
        <label>
          Memo (optional):
          <textarea id="paymentMemo" placeholder="Payment note..." rows="2"></textarea>
        </label>
        <div id="txPreview" class="info" style="display:none;margin-bottom:10px;"></div>
        <button onclick="previewTransaction()">Preview Payment</button>
        <button id="sendPaymentBtn" onclick="sendPayment()" style="display:none;">Send Payment</button>
      </div>

      <div class="section" style="display:none;" id="ownerSection">
        <h3>ðŸ‘‘ Owner Actions</h3>
        <label>
          Withdraw To:
          <input type="text" id="withdrawTo" placeholder="0x...">
        </label>
        <label>
          Amount (CELO):
          <input type="number" id="withdrawAmount" placeholder="0.001" step="0.001">
        </label>
        <button onclick="withdrawFunds()">Withdraw Funds</button>
        <button onclick="withdrawAll()">Withdraw All</button>
        <button onclick="pauseContract()">Pause Contract</button>
        <button onclick="unpauseContract()">Unpause Contract</button>
      </div>

      <div id="status"></div>
      <div class="section">
        <h3>ðŸ“Š Performance Stats</h3>
        <div id="statsPanel" class="info" style="min-height:60px;">Loading stats...</div>
        <button onclick="refreshStatsPanel()">Refresh Stats</button>
      </div>
          function refreshStatsPanel() {
            if (!window.txHistory) return;
            const stats = txHistory.getStats();
            const html = `
              <div><b>Total Transactions:</b> ${stats.total}</div>
              <div><b>Confirmed:</b> ${stats.confirmed} <span style="color:#4CAF50">(${stats.successRate}% success)</span></div>
              <div><b>Pending:</b> ${stats.pending}</div>
              <div><b>Failed:</b> ${stats.failed}</div>
              <div><b>Total Value Sent:</b> ${stats.totalValue} CELO</div>
              <div><b>Total Gas Used:</b> ${stats.totalGasUsed}</div>
            `;
            document.getElementById('statsPanel').innerHTML = html;
          }
          window.addEventListener('DOMContentLoaded', refreshStatsPanel);
    </div>

    <script>
              // Load tx-preview-decoder.js
              let txPreviewDecoder;
              (async function() {
                const module = await import('./tx-preview-decoder.js');
                txPreviewDecoder = module.txPreviewDecoder || window.txPreviewDecoder;
              })();

              function previewTransaction() {
                const memo = document.getElementById('paymentMemo').value || '';
                const iface = new ethers.utils.Interface(["function payWithMemo(string memo)"]);
                const data = iface.encodeFunctionData("payWithMemo", [memo]);
                let preview;
                if (txPreviewDecoder && typeof txPreviewDecoder.decode === 'function') {
                  preview = txPreviewDecoder.decode(data);
                } else {
                  preview = { summary: `Send payment with memo: "${memo}"` };
                }
                const previewDiv = document.getElementById('txPreview');
                if (preview.error) {
                  previewDiv.textContent = preview.error;
                  previewDiv.className = 'error';
                } else {
                  previewDiv.textContent = preview.summary;
                  previewDiv.className = 'info';
                }
                previewDiv.style.display = 'block';
                document.getElementById('sendPaymentBtn').style.display = 'inline-block';
              }

              // Hide preview and send button on memo/amount change
              document.getElementById('paymentMemo').addEventListener('input', () => {
                document.getElementById('txPreview').style.display = 'none';
                document.getElementById('sendPaymentBtn').style.display = 'none';
              });
              document.getElementById('paymentAmount').addEventListener('input', () => {
                document.getElementById('txPreview').style.display = 'none';
                document.getElementById('sendPaymentBtn').style.display = 'none';
              });
        // Theme toggle
        function toggleTheme() {
          const dark = !document.body.classList.contains('dark-theme');
          document.body.classList.toggle('dark-theme', dark);
          localStorage.setItem('celo_theme', dark ? 'dark' : 'light');
          document.getElementById('themeToggleBtn').textContent = dark ? 'ðŸŒž Light Mode' : 'ðŸŒ— Dark Mode';
        }
        window.addEventListener('DOMContentLoaded', () => {
          const theme = localStorage.getItem('celo_theme');
          if (theme === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('themeToggleBtn').textContent = 'ðŸŒž Light Mode';
          } else {
            document.body.classList.remove('dark-theme');
            document.getElementById('themeToggleBtn').textContent = 'ðŸŒ— Dark Mode';
          }
        });
      // Multiple deployed contracts - Choose which one to use
      const CONTRACTS = {
        primary: '0x0B33158062bEBDFc1E6Fe2fA43a6cec943331402',   // CA 1
        secondary: '0xb690E08975b20e61904E7fae6127234F4Fe6FB65', // CA 2
        tertiary: '0x5d0F9219728cc9110577122875966254aaA9c75D'   // CA 3
      };
      
      // Using primary contract
      let CONTRACT_ADDR = CONTRACTS.primary;
      
      let provider, signer, contract, userAddress;
      
      const CONTRACT_ABI = [
        "function payWithMemo(string memory memo) external payable",
        "function withdraw(address payable to, uint256 amount) external",
        "function withdrawAll() external",
        "function pause() external",
        "function unpause() external",
        "function balance() external view returns (uint256)",
        "function getStats() external view returns (uint256, uint256, uint256, uint256, bool)",
        "function owner() external view returns (address)",
        "function paused() external view returns (bool)",
        "event Paid(address indexed payer, uint256 amount, string memo)"
      ];

      // Initialize
      document.getElementById('contractAddr').textContent = CONTRACT_ADDR;

      function switchContract() {
        const selected = document.getElementById('contractSelect').value;
        CONTRACT_ADDR = CONTRACTS[selected];
        document.getElementById('contractAddr').textContent = CONTRACT_ADDR;
        
        // Reinitialize contract if already connected
        if (contract && signer) {
          contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, signer);
          loadStats();
        }
        
        showStatus('Switched to ' + selected + ' contract', 'info');
      }

      async function connectWallet() {
        try {
          if (typeof window.ethereum === 'undefined') {
            showStatus('Please install MetaMask!', 'error');
            return;
          }

          // Request account access
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          userAddress = accounts[0];
        body.dark-theme {
          background: linear-gradient(135deg, #222 0%, #222 100%);
          color: #eee;
        }
        body.dark-theme .container {
          background: #222;
          color: #eee;
          box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        body.dark-theme .section {
          background: #333;
          color: #eee;
          border-left: 5px solid #FCFF52;
        }
        body.dark-theme h1, body.dark-theme h3, body.dark-theme .badge {
          color: #FCFF52;
        }
        body.dark-theme input, body.dark-theme textarea {
          background: #222;
          color: #FCFF52;
          border-color: #444;
        }
        body.dark-theme button {
          background: linear-gradient(135deg, #FCFF52 0%, #35CD8C 100%);
          color: #222;
        }
        body.dark-theme .info, body.dark-theme .success, body.dark-theme .error {
          background: #222;
          color: #FCFF52;
          border-left: 4px solid #35CD8C;
        }

          // Initialize ethers
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, signer);

          // Check if on Celo Mainnet
          const network = await provider.getNetwork();
          if (network.chainId !== 42220) {
            showStatus('Please switch to Celo Mainnet (Chain ID: 42220)', 'error');
            return;
          }

          // Get balance
          const balance = await provider.getBalance(userAddress);
          const balanceCelo = ethers.utils.formatEther(balance);

          // Update UI
          document.getElementById('walletAddress').textContent = 
            userAddress.substring(0, 6) + '...' + userAddress.substring(38);
          document.getElementById('walletBalance').textContent = 
            parseFloat(balanceCelo).toFixed(4);
          document.getElementById('walletInfo').style.display = 'block';
          document.getElementById('connectBtn').textContent = 'âœ… Connected';
          document.getElementById('connectBtn').disabled = true;

          showStatus('Wallet connected successfully!', 'success');

          // Check if user is owner
          try {
            const owner = await contract.owner();
            if (owner.toLowerCase() === userAddress.toLowerCase()) {
              document.getElementById('ownerSection').style.display = 'block';
            }
          } catch (e) {
            console.log('Could not check owner:', e);
          }

          // Load stats
          await loadStats();

        } catch (error) {
          console.error('Connection error:', error);
          showStatus('Failed to connect wallet: ' + error.message, 'error');
        }
      }

      async function loadStats() {
        if (!contract) {
          showStatus('Please connect wallet first', 'error');
          return;
        }

        try {
          const stats = await contract.getStats();
          document.getElementById('statBalance').textContent = 
            parseFloat(ethers.utils.formatEther(stats[0])).toFixed(4);
          document.getElementById('statReceived').textContent = 
            parseFloat(ethers.utils.formatEther(stats[1])).toFixed(4);
          document.getElementById('statWithdrawn').textContent = 
            parseFloat(ethers.utils.formatEther(stats[2])).toFixed(4);
          document.getElementById('statPayments').textContent = stats[3].toString();
          
          document.getElementById('statsContainer').style.display = 'grid';
          showStatus('Stats loaded successfully!', 'success');
        } catch (error) {
          console.error('Stats error:', error);
          showStatus('Failed to load stats: ' + error.message, 'error');
        }
      }

      async function sendPayment() {
        if (!contract) {
          showStatus('Please connect wallet first', 'error');
          return;
        }

        try {
          const amount = document.getElementById('paymentAmount').value;
          const memo = document.getElementById('paymentMemo').value || '';

          if (!amount || parseFloat(amount) <= 0) {
            showStatus('Please enter a valid amount', 'error');
            return;
          }

          showStatus('Sending payment...', 'info');

          const tx = await contract.payWithMemo(memo, {
            value: ethers.utils.parseEther(amount)
          });

          showStatus('Transaction sent! Waiting for confirmation...', 'info');
          await tx.wait();

          showStatus(`Payment sent successfully! TX: ${tx.hash}`, 'success');
          
          // Reload stats
          await loadStats();

        } catch (error) {
          console.error('Payment error:', error);
          showStatus('Payment failed: ' + error.message, 'error');
        }
      }

      async function withdrawFunds() {
        if (!contract) return;

        try {
          const to = document.getElementById('withdrawTo').value;
          const amount = document.getElementById('withdrawAmount').value;

          if (!to || !amount) {
            showStatus('Please enter recipient and amount', 'error');
            return;
          }

          showStatus('Withdrawing...', 'info');

          const tx = await contract.withdraw(to, ethers.utils.parseEther(amount));
          await tx.wait();

          showStatus('Withdrawal successful!', 'success');
          await loadStats();

        } catch (error) {
          showStatus('Withdrawal failed: ' + error.message, 'error');
        }
      }

      async function withdrawAll() {
        if (!contract) return;

        try {
          if (!confirm('Withdraw all funds to your address?')) return;

          showStatus('Withdrawing all...', 'info');

          const tx = await contract.withdrawAll();
          await tx.wait();

          showStatus('All funds withdrawn successfully!', 'success');
          await loadStats();

        } catch (error) {
          showStatus('Withdrawal failed: ' + error.message, 'error');
        }
      }

      async function pauseContract() {
        if (!contract) return;
        try {
          const tx = await contract.pause();
          await tx.wait();
          showStatus('Contract paused!', 'success');
        } catch (error) {
          showStatus('Failed to pause: ' + error.message, 'error');
        }
      }

      async function unpauseContract() {
        if (!contract) return;
        try {
          const tx = await contract.unpause();
          await tx.wait();
          showStatus('Contract unpaused!', 'success');
        } catch (error) {
          showStatus('Failed to unpause: ' + error.message, 'error');
        }
      }

      function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.className = type;
        statusDiv.innerHTML = message;
      }

      // Auto-connect if previously connected
      window.addEventListener('load', async () => {
        if (typeof window.ethereum !== 'undefined') {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            await connectWallet();
          }
        }
      });

      // Handle account changes
      if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            location.reload();
          } else {
            connectWallet();
          }
        });

        window.ethereum.on('chainChanged', () => {
          location.reload();
        });
      }
    </script>
  </body>
</html>
